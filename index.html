<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="–§–æ—Ä–º–∞ —Ñ—É—à–∫–∏">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>–§–æ—Ä–º–∞ —Ñ—É—à–∫–∏</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #2481cc;
      --tg-theme-button-color: #2481cc;
      --tg-theme-button-text-color: #ffffff;
      --primary-color: #1b4d8a;
      --primary-hover: #153d70;
      --error-color: #dc3545;
      --success-color: #28a745;
      --border-color: #e0e0e0;
      --input-bg: #ffffff;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      padding: 0;
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      padding-bottom: 80px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .version {
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      margin-top: 8px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 8px;
      color: var(--tg-theme-text-color);
    }

    .form-label .emoji {
      margin-right: 6px;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px 14px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--input-bg);
      color: var(--tg-theme-text-color);
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-input:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(27, 77, 138, 0.1);
    }

    .form-input.error,
    .form-textarea.error {
      border-color: var(--error-color);
    }

    .form-textarea {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .form-input[type="number"]::-webkit-inner-spin-button,
    .form-input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .form-input[type="number"] {
      -moz-appearance: textfield;
    }

    .error-message {
      display: none;
      color: var(--error-color);
      font-size: 13px;
      margin-top: 6px;
    }

    .error-message.show {
      display: block;
    }

    .required {
      color: var(--error-color);
      margin-left: 2px;
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
        padding-bottom: 80px;
      }

      .header h1 {
        font-size: 24px;
      }

      .form-input,
      .form-textarea {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
      <div class="header">
        <h1>–ù–æ–≤–∞ —Ñ—É—à–∫–∞</h1>
        <div class="version">v5.3 DEBUG</div>
        <div class="version" id="debug-info" style="color: #999; font-size: 10px; margin-top: 5px;"></div>
        <div id="status-log" style="
          background: #f0f0f0;
          padding: 10px;
          margin-top: 10px;
          border-radius: 5px;
          font-size: 11px;
          max-height: 200px;
          overflow-y: auto;
          font-family: monospace;
          text-align: left;
        "></div>
      </div>

    <form id="fushka-form" novalidate autocomplete="off">
      <div class="form-group">
        <label class="form-label" for="description">
          <span class="emoji">üìù</span>–û–ø–∏—Å —Ñ—É—à–∫–∏<span class="required">*</span>
        </label>
        <textarea 
          id="description" 
          name="description" 
          class="form-textarea" 
          required
          maxlength="1000"
        ></textarea>
        <div class="error-message" id="description-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="company">
          <span class="emoji">üè¢</span>–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó<span class="required">*</span>
        </label>
        <input 
          id="company" 
          name="company" 
          class="form-input" 
          type="text" 
          required
          maxlength="200"
        />
        <div class="error-message" id="company-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="location">
          <span class="emoji">üìç</span>–õ–æ–∫–∞—Ü—ñ—è<span class="required">*</span>
        </label>
        <input 
          id="location" 
          name="location" 
          class="form-input" 
          type="text" 
          required
          maxlength="200"
        />
        <div class="error-message" id="location-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="date">
          <span class="emoji">üìÜ</span>–î–∞—Ç–∞<span class="required">*</span>
        </label>
        <input 
          id="date" 
          name="date" 
          class="form-input" 
          type="text" 
          required
          placeholder="–Ω–∞–ø—Ä. 10.10.2025"
          maxlength="50"
        />
        <div class="error-message" id="date-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="hours">
          <span class="emoji">‚è∞</span>–ü–æ—á–∞—Ç–æ–∫ / –∫—ñ–Ω–µ—Ü—å<span class="required">*</span>
        </label>
        <input 
          id="hours" 
          name="hours" 
          class="form-input" 
          type="text" 
          required
          placeholder="–Ω–∞–ø—Ä. 08:00 - 16:00"
          maxlength="50"
        />
        <div class="error-message" id="hours-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="rate">
          <span class="emoji">üí∞</span>–°—Ç–∞–≤–∫–∞ (Kƒç/–≥–æ–¥)<span class="required">*</span>
        </label>
        <input 
          id="rate" 
          name="rate" 
          class="form-input" 
          type="number" 
          required
          min="0"
          max="10000"
          step="0.01"
        />
        <div class="error-message" id="rate-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="type">
          <span class="emoji">üß§</span>–¢–∏–ø —Ä–æ–±–æ—Ç–∏<span class="required">*</span>
        </label>
        <input 
          id="type" 
          name="type" 
          class="form-input" 
          type="text" 
          required
          maxlength="200"
        />
        <div class="error-message" id="type-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="people">
          <span class="emoji">üë§</span>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ª—é–¥–µ–π<span class="required">*</span>
        </label>
        <input 
          id="people" 
          name="people" 
          class="form-input" 
          type="number" 
          required
          min="1"
          max="1000"
          step="1"
        />
        <div class="error-message" id="people-error"></div>
      </div>

      <div class="form-group">
        <label class="form-label" for="note">
          <span class="emoji">üìù</span>–î–æ–¥–∞—Ç–∫–æ–≤–æ
        </label>
        <textarea 
          id="note" 
          name="note" 
          class="form-textarea"
          maxlength="1000"
        ></textarea>
        <div class="error-message" id="note-error"></div>
      </div>

      <button type="submit" id="fallback-submit" style="
        width: 100%;
        padding: 16px;
        font-size: 17px;
        font-weight: 600;
        color: white;
        background-color: #2481cc;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin-top: 30px;
        display: none;
      ">
        –ù–∞–¥—ñ—Å–ª–∞—Ç–∏
      </button>

      <button type="button" id="test-send" style="
        width: 100%;
        padding: 12px;
        font-size: 14px;
        font-weight: 600;
        color: white;
        background-color: #dc3545;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 15px;
      ">
        üß™ –¢–ï–°–¢: –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–∞–ø—Ä—è–º—É
      </button>
  </form>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js?v=7.0"></script>
  <script>
    (function() {
      'use strict';

      let tg = null;
      let isReady = false;
      let useMainButton = false;
      const form = document.getElementById('fushka-form');
      const fallbackBtn = document.getElementById('fallback-submit');
      const statusLog = document.getElementById('status-log');
      const REQUIRED_FIELDS = ['description', 'company', 'location', 'date', 'hours', 'rate', 'type', 'people'];

      function addLog(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#333';
        const entry = document.createElement('div');
        entry.style.color = color;
        entry.textContent = `[${timestamp}] ${message}`;
        statusLog.appendChild(entry);
        statusLog.scrollTop = statusLog.scrollHeight;
        console.log(`[${timestamp}] ${message}`);
      }

      function waitForTelegram(callback, maxAttempts = 50) {
        let attempts = 0;
        addLog('‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è Telegram WebApp...');
        
        const check = () => {
          attempts++;
          
          if (window.Telegram && window.Telegram.WebApp) {
            addLog(`‚úÖ Telegram WebApp –∑–Ω–∞–π–¥–µ–Ω–æ (—Å–ø—Ä–æ–±–∞ ${attempts})`, 'success');
            callback(window.Telegram.WebApp);
            return;
          }
          
          if (attempts >= maxAttempts) {
            addLog(`‚ùå Telegram WebApp –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—ñ—Å–ª—è ${maxAttempts} —Å–ø—Ä–æ–±`, 'error');
            if (fallbackBtn) {
              fallbackBtn.style.display = 'block';
              addLog('‚ö†Ô∏è –ü–æ–∫–∞–∑–∞–Ω–æ fallback –∫–Ω–æ–ø–∫—É');
            }
            return;
          }
          
          setTimeout(check, 100);
        };
        
        check();
      }

      function initTelegramWebApp(webApp) {
        try {
          addLog('üîß –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è WebApp...');
          tg = webApp;
          
          tg.ready();
          tg.expand();
          
          isReady = true;
          
          const debugInfo = {
            platform: tg.platform,
            version: tg.version,
            colorScheme: tg.colorScheme,
            isExpanded: tg.isExpanded,
            viewportHeight: tg.viewportHeight,
            userId: tg.initDataUnsafe?.user?.id,
            hasMainButton: !!tg.MainButton
          };
          
          addLog(`‚úÖ WebApp –≥–æ—Ç–æ–≤–∏–π: ${tg.platform} v${tg.version}`, 'success');
          addLog(`üë§ User ID: ${debugInfo.userId || 'N/A'}`);
          
          const debugElement = document.getElementById('debug-info');
          if (debugElement) {
            debugElement.textContent = `Platform: ${tg.platform} | v${tg.version} | User: ${debugInfo.userId || 'N/A'}`;
          }
          
          if (tg.themeParams) {
            const params = tg.themeParams;
            if (params.bg_color) document.documentElement.style.setProperty('--tg-theme-bg-color', params.bg_color);
            if (params.text_color) document.documentElement.style.setProperty('--tg-theme-text-color', params.text_color);
            if (params.hint_color) document.documentElement.style.setProperty('--tg-theme-hint-color', params.hint_color);
            if (params.button_color) document.documentElement.style.setProperty('--tg-theme-button-color', params.button_color);
            if (params.button_text_color) document.documentElement.style.setProperty('--tg-theme-button-text-color', params.button_text_color);
          }
          
          if (tg.MainButton && typeof tg.MainButton.show === 'function') {
            addLog('üîò MainButton –¥–æ—Å—Ç—É–ø–Ω–∏–π');
            useMainButton = true;
            setupMainButton();
          } else {
            addLog('‚ö†Ô∏è MainButton –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, fallback —Ä–µ–∂–∏–º');
            useMainButton = false;
            setupFallbackButton();
          }
          
        } catch (error) {
          addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${error.message}`, 'error');
          useMainButton = false;
          setupFallbackButton();
        }
      }

      function setupMainButton() {
        addLog('üîò –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è MainButton...');
        
        try {
          tg.MainButton.text = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏';
          tg.MainButton.color = tg.themeParams?.button_color || '#2481cc';
          tg.MainButton.textColor = tg.themeParams?.button_text_color || '#ffffff';
          tg.MainButton.show();
          
          tg.MainButton.onClick(() => {
            addLog('üîò MainButton –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞!');
            handleSubmit();
          });
          
          tg.onEvent('mainButtonClicked', () => {
            addLog('üîò Event: mainButtonClicked');
            handleSubmit();
          });
          
          form.addEventListener('input', checkFormValidity);
          checkFormValidity();
          
          addLog('‚úÖ MainButton –≥–æ—Ç–æ–≤–∞', 'success');
        } catch (error) {
          addLog(`‚ùå –ü–æ–º–∏–ª–∫–∞ MainButton: ${error.message}`, 'error');
          useMainButton = false;
          setupFallbackButton();
        }
      }

      function setupFallbackButton() {
        addLog('üîò –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Fallback –∫–Ω–æ–ø–∫–∏...');
        
        if (fallbackBtn) {
          fallbackBtn.style.display = 'block';
          fallbackBtn.addEventListener('click', handleSubmit);
          addLog('‚úÖ Fallback –∫–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞', 'success');
        }
      }

      function checkFormValidity() {
        const formData = new FormData(form);
        let isValid = true;

        for (const fieldName of REQUIRED_FIELDS) {
          const value = formData.get(fieldName);
          if (!value || (typeof value === 'string' && !value.trim())) {
            isValid = false;
            break;
          }
        }

        if (isValid) {
          tg.MainButton.enable();
        } else {
          tg.MainButton.disable();
        }
      }

      function handleSubmit(event) {
        if (event) {
          event.preventDefault();
        }
        
        addLog(`üéØ Submit! –†–µ–∂–∏–º: ${useMainButton ? 'MainButton' : 'Fallback'}`);
        
        if (!validateForm()) {
          addLog('‚ùå –í–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞', 'error');
          
          if (useMainButton && tg.showAlert) {
            tg.showAlert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
          } else {
            alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
          }
          
          const firstError = document.querySelector('.form-input.error, .form-textarea.error');
          if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          return;
        }

        console.log('‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–æ–π–¥–µ–Ω–∞');
        
        if (useMainButton && tg.MainButton) {
          tg.MainButton.showProgress();
          tg.MainButton.disable();
        } else if (fallbackBtn) {
          fallbackBtn.disabled = true;
          fallbackBtn.textContent = '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...';
        }

        try {
          const data = collectFormData();
          console.log('üì§ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö:', Object.keys(data));
          sendDataToBot(data);
        } catch (error) {
          console.error('‚ùå –ü–æ–º–∏–ª–∫–∞:', error);
          
          if (useMainButton && tg.MainButton) {
            tg.MainButton.hideProgress();
            tg.MainButton.enable();
            if (tg.showAlert) {
              tg.showAlert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }
          } else if (fallbackBtn) {
            fallbackBtn.disabled = false;
            fallbackBtn.textContent = '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏';
            alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
          }
        }
      }

      function sanitizeInput(input) {
        if (typeof input !== 'string') {
          return input;
        }
        const div = document.createElement('div');
        div.textContent = input;
        return div.innerHTML;
      }

      function validateField(fieldName, value) {
        const trimmedValue = typeof value === 'string' ? value.trim() : value;

        if (REQUIRED_FIELDS.includes(fieldName)) {
          if (!trimmedValue && trimmedValue !== 0) {
            return '–¶–µ –ø–æ–ª–µ –æ–±–æ–≤\'—è–∑–∫–æ–≤–µ';
          }
        }

        if (fieldName === 'rate') {
          const numValue = parseFloat(value);
          if (isNaN(numValue) || numValue < 0 || numValue > 10000) {
            return '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É —Å—Ç–∞–≤–∫—É (0-10000)';
          }
        }

        if (fieldName === 'people') {
          const numValue = parseInt(value, 10);
          if (isNaN(numValue) || numValue < 1 || numValue > 1000) {
            return '–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å (1-1000)';
          }
        }

        if (typeof trimmedValue === 'string' && trimmedValue.length > 1000) {
          return '–ó–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π —Ç–µ–∫—Å—Ç';
        }

        return null;
      }

      function showFieldError(fieldName, errorMessage) {
        const field = document.getElementById(fieldName);
        const errorElement = document.getElementById(`${fieldName}-error`);

        if (field) {
          field.classList.add('error');
        }

        if (errorElement && errorMessage) {
          errorElement.textContent = errorMessage;
          errorElement.classList.add('show');
        }
      }

      function clearFieldError(fieldName) {
        const field = document.getElementById(fieldName);
        const errorElement = document.getElementById(`${fieldName}-error`);

        if (field) {
          field.classList.remove('error');
        }

        if (errorElement) {
          errorElement.textContent = '';
          errorElement.classList.remove('show');
        }
      }

      function validateForm() {
        let isValid = true;
        const formData = new FormData(form);

        REQUIRED_FIELDS.forEach(fieldName => {
          clearFieldError(fieldName);
          const value = formData.get(fieldName);
          const error = validateField(fieldName, value);

          if (error) {
            showFieldError(fieldName, error);
            isValid = false;
          }
        });

        return isValid;
      }

    function collectFormData() {
      const formData = new FormData(form);
      const data = {};
      
        for (const [key, value] of formData.entries()) {
          const sanitizedValue = sanitizeInput(value);
          data[key] = sanitizedValue;
      }
      
      data.timestamp = new Date().toISOString();
        data.userAgent = navigator.userAgent.substring(0, 200);
      
      return data;
    }

      function sendDataToBot(data) {
        addLog('üì§ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏...');

        try {
          const jsonData = JSON.stringify(data);
          
          addLog(`üìä –†–æ–∑–º—ñ—Ä –¥–∞–Ω–∏—Ö: ${jsonData.length} bytes`);
          addLog(`üìã –ü–æ–ª—è: ${Object.keys(data).join(', ')}`);
          
          if (jsonData.length > 64000) {
            throw new Error('–î–∞–Ω—ñ –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫—ñ');
          }

          if (!tg) {
            throw new Error('Telegram WebApp –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
          }

          if (typeof tg.sendData !== 'function') {
            throw new Error('tg.sendData –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π');
          }

          addLog('üöÄ –í–∏–∫–ª–∏–∫ tg.sendData()...');
          tg.sendData(jsonData);
          addLog('‚úÖ –î–∞–Ω—ñ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
          addLog('‚è≥ –ó–∞–∫—Ä–∏—Ç—Ç—è —á–µ—Ä–µ–∑ 2000–º—Å (—á–µ–∫–∞—î–º–æ –±–æ—Ç–∞)...');
          
          setTimeout(() => {
            if (tg && typeof tg.close === 'function') {
              addLog('üö™ –ó–∞–∫—Ä–∏—Ç—Ç—è WebApp...');
              tg.close();
            }
          }, 2000);
          
        } catch (error) {
          addLog(`‚ùå –ü–û–ú–ò–õ–ö–ê: ${error.message}`, 'error');
          throw error;
        }
      }

      function setupFormValidation() {
        REQUIRED_FIELDS.forEach(fieldName => {
          const field = document.getElementById(fieldName);
          if (field) {
            field.addEventListener('blur', function() {
              const error = validateField(fieldName, this.value);
              if (error) {
                showFieldError(fieldName, error);
              } else {
                clearFieldError(fieldName);
              }
            });

            field.addEventListener('input', function() {
              if (field.classList.contains('error')) {
                clearFieldError(fieldName);
              }
            });
          }
        });
      }

      function init() {
        addLog('üöÄ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è v5.3...');
        
        setupFormValidation();
        
        form.addEventListener('submit', handleSubmit);
        
        const testBtn = document.getElementById('test-send');
        if (testBtn) {
          testBtn.addEventListener('click', () => {
            addLog('üß™ –¢–ï–°–¢–û–í–ê –∫–Ω–æ–ø–∫–∞ –Ω–∞—Ç–∏—Å–Ω—É—Ç–∞');
            handleSubmit();
          });
        }
        
        waitForTelegram(initTelegramWebApp);
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
